
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>komanawa.kendall_stats.multi_part_kendall &#8212; komanawa-kendall-stats v2.0.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../../_static/documentation_options.js?v=9dfb15f6"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/komanawa/kendall_stats/multi_part_kendall';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../../_static/ksl_for_latex.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">Kendall-Stats v2.0.3 Overview</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../autoapi/komanawa/kendall_stats/index.html">
    Code documentation
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Komanawa-Solutions-Ltd/komanawa-kendall-stats" title="View on GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">View on GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/company/k%C5%8Dmanawa-solutions-ltd/" title="Follow us on LinkedIn" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Follow us on LinkedIn</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.komanawa.com" title="Kо̄manawa Solutions Ltd." class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/just_symbol.png" class="icon-link-image" alt="Kо̄manawa Solutions Ltd."/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../autoapi/komanawa/kendall_stats/index.html">
    Code documentation
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Komanawa-Solutions-Ltd/komanawa-kendall-stats" title="View on GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">View on GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/company/k%C5%8Dmanawa-solutions-ltd/" title="Follow us on LinkedIn" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-linkedin fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Follow us on LinkedIn</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.komanawa.com" title="Kо̄manawa Solutions Ltd." class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/just_symbol.png" class="icon-link-image" alt="Kо̄manawa Solutions Ltd."/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">komanawa.ken...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for komanawa.kendall_stats.multi_part_kendall</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">created matt_dumont </span>
<span class="sd">on: 21/09/23</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.transforms</span> <span class="kn">import</span> <span class="n">blended_transform_factory</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mstats</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">komanawa.kendall_stats.mann_kendall</span> <span class="kn">import</span> <span class="n">_mann_kendall_from_sarray</span><span class="p">,</span> <span class="n">_seasonal_mann_kendall_from_sarray</span><span class="p">,</span> \
    <span class="n">_calc_seasonal_senslope</span><span class="p">,</span> <span class="n">get_colors</span><span class="p">,</span> <span class="n">_make_s_array</span>


<span class="k">def</span> <span class="nf">_generate_startpoints</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">nparts</span><span class="p">,</span> <span class="n">check_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nparts</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">check_step</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">((</span><span class="n">all_start_points_out</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">all_start_points_out</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_start_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">start_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_size</span> <span class="o">+</span> <span class="n">min_size</span> <span class="o">*</span> <span class="n">part</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">part</span><span class="p">)),</span> <span class="n">check_step</span><span class="p">)</span>
                <span class="n">all_start_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>

            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">all_start_points</span><span class="p">)))</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">all_start_points_out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">[</span><span class="n">all_start_points_out</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">all_start_points_out</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>

            <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">all_start_points_out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sizes</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">check_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nparts</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">check_window</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">check_window</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">check_step</span><span class="p">,</span> <span class="n">check_step</span><span class="p">)[:,</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_start_points</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">start_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">check_window</span><span class="p">[</span><span class="n">part</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">check_window</span><span class="p">[</span><span class="n">part</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">check_step</span><span class="p">,</span> <span class="n">check_step</span><span class="p">)</span>
                <span class="n">all_start_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">all_start_points</span><span class="p">)))</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>

            <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">all_start_points_out</span> <span class="o">=</span> <span class="n">all_start_points_out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sizes</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_start_points_out</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>

        <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sizes</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_start_points_out</span>


<div class="viewcode-block" id="MultiPartKendall">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall">[docs]</a>
<span class="k">class</span> <span class="nc">MultiPartKendall</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">data_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rm_na</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">serialise_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">check_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        multi part mann kendall test to indentify a change point(s) in a time series after Frollini et al., 2020, DOI: 10.1007/s11356-020-11998-0 note where the expected trend is zero the lack of a trend is considered significant if p &gt; 1-alpha</span>

<span class="sd">        :param data: time series data, if DataFrame or Series, expects the index to be sample order (will sort on index) if np.array or list expects the data to be in sample order</span>
<span class="sd">        :param nparts: number of parts to split the time series into</span>
<span class="sd">        :param expect_part: expected trend in each part of the time series (1 increasing, -1 decreasing, 0 no trend)</span>
<span class="sd">        :param min_size: minimum size for the first and last section of the time series</span>
<span class="sd">        :param alpha: significance level</span>
<span class="sd">        :param no_trend_alpha: significance level for no trend e.g. will accept if p&gt; no_trend_alpha</span>
<span class="sd">        :param data_col: if data is a DataFrame or Series, the column to use</span>
<span class="sd">        :param rm_na: remove na values from the data</span>
<span class="sd">        :param serialise_path: path to serialised file (as hdf), if None will not serialise</span>
<span class="sd">        :param check_step: int, the step to check for breakpoints, e.g. if 1 will check every point, if 2 will check every second point</span>
<span class="sd">        :param check_window: the window to check for breakpoints.  if None will use the whole data.  this is used to significantly speed up the mann kendall test. Note that check_step still applies to the check_window (e.g. a check_window of (2, 6) with a check_step of 2 will check the points (2, 4, 6)) One of:</span>

<span class="sd">            * None or tuple (start_idx, end_idx) (one breakpoint only)</span>
<span class="sd">            * list of tuples of len nparts-1 with a start/end idx for each part,</span>
<span class="sd">            * or a 2d array shape (nparts-1, 2) with a start/end idx for each part,</span>

<span class="sd">        :param recalc: if True will recalculate the mann kendall even if the serialised file exists</span>
<span class="sd">        :param initalize: if True will initalize the class from the data, only set to False used in self.from_file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;increasing&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;decreasing&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;no trend&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">initalize</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">nparts</span><span class="p">,</span> <span class="n">expect_part</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">rm_na</span><span class="p">,</span> <span class="n">serialise_path</span><span class="p">,</span>
                         <span class="n">recalc</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">serialise_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">serialise_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">serialise_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="n">serialise_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">serialise_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
                    <span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_from_file</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">nparts</span><span class="o">=</span><span class="n">nparts</span><span class="p">,</span>
                        <span class="n">expect_part</span><span class="o">=</span><span class="n">expect_part</span><span class="p">,</span>
                        <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">no_trend_alpha</span><span class="o">=</span><span class="n">no_trend_alpha</span><span class="p">,</span>
                        <span class="n">data_col</span><span class="o">=</span><span class="n">data_col</span><span class="p">,</span>
                        <span class="n">rm_na</span><span class="o">=</span><span class="n">rm_na</span><span class="p">,</span>
                        <span class="n">check_step</span><span class="o">=</span><span class="n">check_step</span><span class="p">,</span>
                        <span class="n">check_window</span><span class="o">=</span><span class="n">check_window</span><span class="p">,</span>
                        <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_from_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">nparts</span><span class="o">=</span><span class="n">nparts</span><span class="p">,</span>
                                    <span class="n">expect_part</span><span class="o">=</span><span class="n">expect_part</span><span class="p">,</span>
                                    <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                    <span class="n">no_trend_alpha</span><span class="o">=</span><span class="n">no_trend_alpha</span><span class="p">,</span>
                                    <span class="n">data_col</span><span class="o">=</span><span class="n">data_col</span><span class="p">,</span>
                                    <span class="n">rm_na</span><span class="o">=</span><span class="n">rm_na</span><span class="p">,</span>
                                    <span class="n">check_step</span><span class="o">=</span><span class="n">check_step</span><span class="p">,</span>
                                    <span class="n">check_window</span><span class="o">=</span><span class="n">check_window</span><span class="p">,</span>
                                    <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">check_step</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">data_col</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">rm_na</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">season_col</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nparts</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_size</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">no_trend_alpha</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">expect_part</span><span class="p">))</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">datatype_other</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">datatype_other</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">check_window</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">datatype_other</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check datasets</span>
                <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_series_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ndarray&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown datatype </span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">*=</span> <span class="kc">False</span>

        <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">idx_values</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">season_data</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">s_array</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">*=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<div class="viewcode-block" id="SeasonalMultiPartKendall.print_mk_diffs">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.print_mk_diffs">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.print_mk_diffs">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.print_mk_diffs">[docs]</a>
    <span class="k">def</span> <span class="nf">print_mk_diffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convenience function to print the differences between two MultiPartKendall classes</span>
<span class="sd">        :param other: another MultiPartKendall class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;problem with class: not same class: got &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">check_step</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with check step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">check_step</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">check_step</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">data_col</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with data col </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">data_col</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">rm_na</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with rm_na </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span><span class="si">=}</span><span class="s1"> other: </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">rm_na</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">season_col</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with season col </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">season_col</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nparts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with nparts: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">nparts</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">min_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with min_size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">min_size</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">alpha</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with alpha </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">alpha</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">no_trend_alpha</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with no_trend_alpha </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">no_trend_alpha</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">expect_part</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with expect_part </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">expect_part</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">datatype_other</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">datatype_other</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with datatype </span><span class="si">{</span><span class="n">datatype</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">datatype_other</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with check_window, should both be None </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">check_window</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">check_window</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with check_window </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">check_window</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="n">datatype_other</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check datasets</span>
                <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_series_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="p">)</span>
                <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ndarray&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unknown datatype </span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with data&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with x&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">idx_values</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with idx_values&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with acceptable_matches&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">season_data</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with season_data&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">s_array</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;problem with s_array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;problem with all_start_points&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;problem with datasets&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span></div>
</div>


<div class="viewcode-block" id="SeasonalMultiPartKendall.get_acceptable_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.get_acceptable_matches">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.get_acceptable_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.get_acceptable_matches">[docs]</a>
    <span class="k">def</span> <span class="nf">get_acceptable_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the acceptable matches for the multipart kendall test</span>
<span class="sd">        :return: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matches</span><span class="p">(</span><span class="n">acceptable_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SeasonalMultiPartKendall.get_all_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.get_all_matches">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.get_all_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.get_all_matches">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the all matches for the multipart kendall test (including those that are not significant)</span>
<span class="sd">        :return: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_matches</span><span class="p">(</span><span class="n">acceptable_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>


    <span class="k">def</span> <span class="nf">_get_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acceptable_only</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">acceptable_only</span><span class="p">:</span>
            <span class="n">use_idx</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">outdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">use_idx</span><span class="p">]</span>
        <span class="n">outdata</span> <span class="o">=</span> <span class="n">outdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)])</span>
        <span class="n">outdata</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">_p0&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">]},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="n">next_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">use_idx</span><span class="p">]</span>
            <span class="n">next_data</span> <span class="o">=</span> <span class="n">next_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)])</span>
            <span class="n">next_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">_p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">]},</span>
                             <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">outdata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">outdata</span><span class="p">,</span> <span class="n">next_data</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                    <span class="o">/</span>
                    <span class="p">(</span><span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;znorm_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">temp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outdata</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;znorm_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="n">outdata</span><span class="p">[</span><span class="s1">&#39;znorm_joint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outdata</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;znorm_p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">outdata</span><span class="p">)</span>


<div class="viewcode-block" id="SeasonalMultiPartKendall.get_maxz_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.get_maxz_breakpoints">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.get_maxz_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.get_maxz_breakpoints">[docs]</a>
    <span class="k">def</span> <span class="nf">get_maxz_breakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_on_none</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the breakpoints for the maximum joint normalised (min-max for each part) z the best match is the maximum znorm_joint value where:</span>

<span class="sd">           *  if expected trend == 1 or -1:</span>
<span class="sd">              *  znorm = the min-max normalised z value for each part</span>
<span class="sd">           *  else: (no trend expected)</span>
<span class="sd">              *  znorm = 1 - the min-max normalised z value for each part</span>
<span class="sd">           *  and</span>
<span class="sd">              *  znorm_joint = the sum of the znorm values for each part</span>

<span class="sd">        :param raise_on_none: bool, if True will raise an error if no acceptable matches, otherwise will return None</span>
<span class="sd">        :return: array of breakpoint tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acceptable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acceptable_matches</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">acceptable</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_on_none</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no acceptable matches&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">best</span> <span class="o">=</span> <span class="n">acceptable</span><span class="p">[</span><span class="n">acceptable</span><span class="p">[</span><span class="s1">&#39;znorm_joint&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">acceptable</span><span class="p">[</span><span class="s1">&#39;znorm_joint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">best</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span></div>
</div>


<div class="viewcode-block" id="SeasonalMultiPartKendall.get_data_from_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.get_data_from_breakpoints">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.get_data_from_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.get_data_from_breakpoints">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_from_breakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the data from the breakpoints</span>

<span class="sd">        :param breakpoints: beakpoints to split the data, e.g. from self.get_acceptable_matches</span>

<span class="sd">        :return: outdata: list of dataframes for each part of the time series</span>
<span class="sd">        :return: kendal_stats: dataframe of kendal stats for each part of the time series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">outdata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kendal_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)],</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">,</span> <span class="s1">&#39;senslope&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;senintercept&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">assert</span> <span class="n">pkey</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)])</span>
            <span class="n">outcols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">]</span>
            <span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outcols</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">),</span> <span class="n">outcols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">breakpoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]])))</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># calculate the senslope stats</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outdata</span><span class="p">):</span>
            <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_senslope</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;sen_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">senslope</span>
            <span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;sen_intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">senintercept</span>

        <span class="k">return</span> <span class="n">outdata</span><span class="p">,</span> <span class="n">kendal_stats</span></div>
</div>


<div class="viewcode-block" id="SeasonalMultiPartKendall.plot_acceptable_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.plot_acceptable_matches">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.plot_acceptable_matches">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.plot_acceptable_matches">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_acceptable_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        quickly plot the acceptable matches</span>

<span class="sd">        :param key: key to plot (one of [&#39;p&#39;, &#39;z&#39;, &#39;s&#39;, &#39;var_s&#39;,&#39;znorm&#39;, znorm_joint]) or &#39;all&#39; a figure for each value note joint stats only have 1 value</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">poss_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">,</span> <span class="s1">&#39;znorm&#39;</span><span class="p">,</span> <span class="s1">&#39;znorm_joint&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">poss_keys</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">poss_keys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">figs</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">acceptable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acceptable_matches</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;joint&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">use_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">use_keys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)]</span>
            <span class="n">acceptable</span> <span class="o">=</span> <span class="n">acceptable</span><span class="p">[</span><span class="n">use_keys</span><span class="p">]</span>
            <span class="n">acceptable</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">axs</span></div>
</div>


<div class="viewcode-block" id="SeasonalMultiPartKendall.plot_data_from_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.plot_data_from_breakpoints">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.plot_data_from_breakpoints">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.plot_data_from_breakpoints">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_data_from_breakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">txt_vloc</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">add_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the data from the breakpoints including the senslope fits</span>

<span class="sd">        :param breakpoints:</span>
<span class="sd">        :param ax: ax to plot on if None then create the ax</span>
<span class="sd">        :param txt_vloc: vertical location of the text (in ax.transAxes)</span>
<span class="sd">        :param add_labels: boolean, if True add labels (slope, pval) to the plot</span>
<span class="sd">        :param kwargs: passed to ax.scatter (all parts)</span>
<span class="sd">        :return: fig, ax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">kendal_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_from_breakpoints</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="c1"># axhlines at breakpoints</span>
        <span class="n">prev_bp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">breakpoints</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]))):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bp</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">sslope</span> <span class="o">=</span> <span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;sen_slope&quot;</span><span class="p">]</span>
            <span class="n">sintercept</span> <span class="o">=</span> <span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;sen_intercept&quot;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">[</span><span class="n">prev_bp</span><span class="p">:</span><span class="n">bp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">add_labels</span><span class="p">:</span>
                <span class="n">xval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span>
                        <span class="n">txt_vloc</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;expected: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trend_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;got: slope: </span><span class="si">{</span><span class="n">sslope</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;pval:</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">kendal_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;p&quot;</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

            <span class="c1"># plot the senslope fit and intercept</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">sslope</span> <span class="o">+</span> <span class="n">sintercept</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">prev_bp</span> <span class="o">=</span> <span class="n">bp</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">colors</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;part </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;part </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seasons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_data</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">seasons</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;season: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">),</span>
                          <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)]</span>

        <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;breakpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;sen slope fit&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">nhandles</span><span class="p">,</span> <span class="n">nlabels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nlabels</span><span class="p">,</span> <span class="n">nhandles</span><span class="p">))</span>
        <span class="n">legend_handles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">legend_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>
</div>


    <span class="k">def</span> <span class="nf">_set_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nparts</span><span class="p">,</span> <span class="n">expect_part</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">rm_na</span><span class="p">,</span>
                       <span class="n">check_step</span><span class="p">,</span> <span class="n">check_window</span><span class="p">,</span> <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setup the class data from a serialised file, values are passed to ensure they are consistent</span>

<span class="sd">        :param check_inputs: bool, if True will check the inputs match the serialised file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;serialise path not set, should not get here&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;params&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="c1"># other parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;check_step&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;check_step&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># support legacy files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;no_trend_alpha&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;nparts&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_size&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rm_na&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;expect_part</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)]</span>
        <span class="k">if</span> <span class="s1">&#39;freq_limit&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;freq_limit&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">params_str</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;params_str&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">=</span> <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;season_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">=</span> <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;data_col&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># d1 data</span>
        <span class="n">d1_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;d1_data&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">d1_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span> <span class="o">=</span> <span class="n">d1_data</span><span class="p">[</span><span class="s1">&#39;idx_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;acceptable_matches&#39;</span><span class="p">)</span>

        <span class="c1"># check window</span>
        <span class="k">if</span> <span class="s1">&#39;check_window&#39;</span> <span class="ow">in</span> <span class="n">params_str</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;check_window&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">temp</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">store</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;check_window&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>  <span class="c1"># support legacy files</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_window&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">values</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;pd.DataFrame&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;pd.Series&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;np.array&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown datatype, thou shall not pass&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># s array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_array</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;s_array&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># all start points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;all_start_points&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># datasets</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">:</span> <span class="s1">&#39;float64&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;int64&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;part</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_inputs</span><span class="p">:</span>
            <span class="c1"># check parameters have not changed</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">==</span> <span class="n">data_col</span><span class="p">,</span> <span class="s1">&#39;data_col does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span> <span class="o">==</span> <span class="n">rm_na</span><span class="p">,</span> <span class="s1">&#39;rm_na does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">==</span> <span class="n">season_col</span><span class="p">,</span> <span class="s1">&#39;season_col does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">==</span> <span class="n">nparts</span><span class="p">,</span> <span class="s1">&#39;nparts does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">==</span> <span class="n">min_size</span><span class="p">,</span> <span class="s1">&#39;min_size does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span> <span class="o">==</span> <span class="n">no_trend_alpha</span><span class="p">,</span> <span class="s1">&#39;no_trend_alpha does not match&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">==</span> <span class="n">check_step</span><span class="p">,</span> <span class="s1">&#39;check_step does not match&#39;</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">expect_part</span><span class="p">)),</span> <span class="s1">&#39;expect_part does not match&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">check_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;check_window does not match&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">check_window</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="p">,</span> <span class="n">check_window</span><span class="p">),</span> <span class="s1">&#39;check_window does not match&#39;</span>

            <span class="c1"># check datasets</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;pd.DataFrame&#39;</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;pd.Series&#39;</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_series_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;np.array&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nparts</span><span class="p">,</span> <span class="n">expect_part</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">rm_na</span><span class="p">,</span>
                       <span class="n">check_step</span><span class="p">,</span> <span class="n">check_window</span><span class="p">,</span> <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set up the class data from the input data</span>

<span class="sd">        :param data:</span>
<span class="sd">        :param nparts:</span>
<span class="sd">        :param expect_part:</span>
<span class="sd">        :param min_size:</span>
<span class="sd">        :param alpha:</span>
<span class="sd">        :param data_col:</span>
<span class="sd">        :param rm_na:</span>
<span class="sd">        :param season_col:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span> <span class="o">=</span> <span class="n">no_trend_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">=</span> <span class="n">nparts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">=</span> <span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span> <span class="o">=</span> <span class="n">expect_part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_col</span> <span class="o">=</span> <span class="n">data_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span> <span class="o">=</span> <span class="n">rm_na</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">expect_part</span><span class="p">)</span> <span class="o">==</span> <span class="n">nparts</span>

        <span class="c1"># handle data (including options for season)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="o">=</span> <span class="n">season_col</span>
        <span class="k">if</span> <span class="n">season_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;season_col passed but data is not a &#39;</span>
                                                                              <span class="s1">&#39;DataFrame or dictionary&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">season_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;season_col not in data&#39;</span>
            <span class="k">assert</span> <span class="n">data_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data_col must be passed if season_col is passed&#39;</span>
            <span class="k">assert</span> <span class="n">data_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;data_col not in data&#39;</span>
            <span class="k">if</span> <span class="n">rm_na</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">data_col</span><span class="p">,</span> <span class="n">season_col</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">season_col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data_col</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">data_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data_col</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rm_na</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;data must be 1d or multi d but with col_name passed&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the time series is too short for the minimum size&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_array</span> <span class="o">=</span> <span class="n">_make_s_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">check_step</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">check_step</span><span class="si">=}</span><span class="s1"> must be an int&#39;</span>
        <span class="k">assert</span> <span class="n">check_step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">check_step</span><span class="si">=}</span><span class="s1"> must be &gt; 0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span> <span class="o">=</span> <span class="n">check_step</span>

        <span class="k">if</span> <span class="n">check_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">check_window</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">check_window</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">check_window</span><span class="si">=}</span><span class="s1"> must have shape (nparts-1, 2)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="o">=</span> <span class="n">check_window</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">(</span>
                    <span class="s1">&#39;check_window contains values not in data index&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">data_col</span><span class="p">:</span>
                    <span class="n">check_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

                <span class="k">assert</span> <span class="ow">not</span> <span class="n">check_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="p">(</span>
                    <span class="s1">&#39;check_window references nan values&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="p">(</span>
                        <span class="s1">&#39;check_window references nan values&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="s1">&#39;check_window references nan values&#39;</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s1">&#39;check_window contains values &lt; min_size&#39;</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">(</span>
                <span class="s1">&#39;n - check_window contains values &lt;min_size&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">all_start_points</span> <span class="o">=</span> <span class="n">_generate_startpoints</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_check_window</span><span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparts</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span> <span class="o">=</span> <span class="n">all_start_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_mann_kendall</span><span class="p">()</span>

        <span class="c1"># find all acceptable matches</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">expect</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">expect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">trend</span> <span class="o">==</span> <span class="n">expect</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span><span class="p">)</span>
                       <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">trend</span> <span class="o">==</span> <span class="n">expect</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                       <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span> <span class="o">=</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">_calc_senslope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span><span class="p">,</span> <span class="n">lo_slope</span><span class="p">,</span> <span class="n">up_slope</span> <span class="o">=</span> <span class="n">mstats</span><span class="o">.</span><span class="n">theilslopes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                                                            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span><span class="p">,</span> <span class="n">lo_slope</span><span class="p">,</span> <span class="n">up_slope</span> <span class="o">=</span> <span class="n">mstats</span><span class="o">.</span><span class="n">theilslopes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span>

    <span class="k">def</span> <span class="nf">_calc_mann_kendall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        acutually calculate the mann kendall from the sarray, this should be the only thing that needs to be updated for the seasonal kendall</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">temp_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">temp_key</span> <span class="ow">in</span> <span class="n">temp_data</span><span class="p">:</span>
                    <span class="n">datai</span> <span class="o">=</span> <span class="n">temp_data</span><span class="p">[</span><span class="n">temp_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">datai</span> <span class="o">=</span> <span class="n">_mann_kendall_from_sarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                      <span class="n">sarray</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
                    <span class="n">temp_data</span><span class="p">[</span><span class="n">temp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datai</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">datai</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
                                                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)]</span>
                                                             <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="SeasonalMultiPartKendall.to_file">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.to_file">[docs]</a>
<div class="viewcode-block" id="MultiPartKendall.to_file">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.to_file">[docs]</a>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc:lz4&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save the data to a hdf file</span>

<span class="sd">        :param save_path: None (save to self.serialise_path) or path to save the file</span>
<span class="sd">        :param complevel: compression level for hdf</span>
<span class="sd">        :param complib: compression library for hdf</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;serialise path not set, should not get here&#39;</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span>
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf</span><span class="p">:</span>
            <span class="c1"># setup single value parameters</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
            <span class="n">params_str</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>

            <span class="c1"># should be 1d+ of same length</span>
            <span class="n">d1_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">d1_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
            <span class="n">d1_data</span><span class="p">[</span><span class="s1">&#39;idx_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_values</span>
            <span class="n">d1_data</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;d1_data&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_matches</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="s1">&#39;acceptable_matches&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
            <span class="c1"># save as own datasets</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
                <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pd.DataFrame&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
                <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pd.Series&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;np.array&#39;</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;s_array&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;all_start_points&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;part</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>

            <span class="c1"># check_window</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_window</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_window&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;check_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

            <span class="c1"># other parameters</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;no_trend_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_trend_alpha</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nparts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rm_na&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_na</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;check_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;freq_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;expect_part</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_part</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;season_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="p">)</span>
            <span class="n">params_str</span><span class="p">[</span><span class="s1">&#39;data_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span>
            <span class="n">params_str</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;params_str&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">complib</span><span class="p">)</span></div>
</div>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MultiPartKendall.from_file">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.MultiPartKendall.from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load the class from a serialised file</span>

<span class="sd">        :param path: path to the serialised file</span>
<span class="sd">        :return: MultiPartKendall</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpk</span> <span class="o">=</span> <span class="n">MultiPartKendall</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">serialise_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rm_na</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mpk</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mpk</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mpk</span><span class="o">.</span><span class="n">_set_from_file</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">data_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rm_na</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">check_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mpk</span></div>
</div>



<div class="viewcode-block" id="SeasonalMultiPartKendall">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall">[docs]</a>
<span class="k">class</span> <span class="nc">SeasonalMultiPartKendall</span><span class="p">(</span><span class="n">MultiPartKendall</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">season_col</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">rm_na</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">serialise_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_limit</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">check_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        multi part seasonal mann kendall test to indentify a change point(s) in a time series after Frollini et al., 2020, DOI: 10.1007/s11356-020-11998-0</span>

<span class="sd">        :param data: time series data, if DataFrame or Series, expects the index to be sample order (will sort on index)if np.array or list expects the data to be in sample order</span>
<span class="sd">        :param data_col: if data is a DataFrame or Series, the column to use</span>
<span class="sd">        :param season_col: the column to use for the season</span>
<span class="sd">        :param nparts: number of parts to split the time series into</span>
<span class="sd">        :param expect_part: expected trend in each part of the time series (1 increasing, -1 decreasing, 0 no trend)</span>
<span class="sd">        :param min_size: minimum size for the first and last section of the time series</span>
<span class="sd">        :param alpha: significance level</span>
<span class="sd">        :param no_trend_alpha: significance level for no trend e.g. will accept if p&gt; no_trend_alpha</span>
<span class="sd">        :param rm_na: remove na values from the data</span>
<span class="sd">        :param serialise_path: path to serialised file (as hdf), if None will not serialise</span>
<span class="sd">        :param check_step: int, the step to check for breakpoints, e.g. if 1 will check every point, if 2 will check every second point</span>
<span class="sd">        :param check_window: the window to check for breakpoints.  if None will use the whole data.  this is used to significantly speed up the mann kendall test Note that check_step still applies to the check_window (e.g. a check_window of (2, 6) with a check_step of 2 will check the points (2, 4, 6))  one of:</span>

<span class="sd">               * None or tuple (start_idx, end_idx) (one breakpoint only)</span>
<span class="sd">               * or list of tuples of len nparts-1 with a start/end idx for each part,</span>
<span class="sd">               * or a 2d array shape (nparts-1, 2) with a start/end idx for each part</span>

<span class="sd">        :param recalc: if True will recalculate the mann kendall even if the serialised file exists</span>
<span class="sd">        :param initalize: if True will initalize the class from the data, only set to False used in self.from_file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;increasing&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;decreasing&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;no trend&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span> <span class="o">=</span> <span class="n">freq_limit</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">initalize</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">nparts</span><span class="p">,</span> <span class="n">expect_part</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">rm_na</span><span class="p">,</span> <span class="n">serialise_path</span><span class="p">,</span>
                         <span class="n">recalc</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">serialise_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">serialise_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">serialise_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="n">serialise_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">serialise_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
                    <span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_from_file</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">nparts</span><span class="o">=</span><span class="n">nparts</span><span class="p">,</span>
                        <span class="n">expect_part</span><span class="o">=</span><span class="n">expect_part</span><span class="p">,</span>
                        <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">no_trend_alpha</span><span class="o">=</span><span class="n">no_trend_alpha</span><span class="p">,</span>
                        <span class="n">data_col</span><span class="o">=</span><span class="n">data_col</span><span class="p">,</span>
                        <span class="n">rm_na</span><span class="o">=</span><span class="n">rm_na</span><span class="p">,</span>
                        <span class="n">check_step</span><span class="o">=</span><span class="n">check_step</span><span class="p">,</span>
                        <span class="n">check_window</span><span class="o">=</span><span class="n">check_window</span><span class="p">,</span>
                        <span class="n">season_col</span><span class="o">=</span><span class="n">season_col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_from_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">nparts</span><span class="o">=</span><span class="n">nparts</span><span class="p">,</span>
                                    <span class="n">expect_part</span><span class="o">=</span><span class="n">expect_part</span><span class="p">,</span>
                                    <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                    <span class="n">no_trend_alpha</span><span class="o">=</span><span class="n">no_trend_alpha</span><span class="p">,</span>
                                    <span class="n">data_col</span><span class="o">=</span><span class="n">data_col</span><span class="p">,</span>
                                    <span class="n">rm_na</span><span class="o">=</span><span class="n">rm_na</span><span class="p">,</span>
                                    <span class="n">check_step</span><span class="o">=</span><span class="n">check_step</span><span class="p">,</span>
                                    <span class="n">check_window</span><span class="o">=</span><span class="n">check_window</span><span class="p">,</span>
                                    <span class="n">season_col</span><span class="o">=</span><span class="n">season_col</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SeasonalMultiPartKendall.from_file">
<a class="viewcode-back" href="../../../autoapi/komanawa/kendall_stats/time_tests_check_step_window/index.html#komanawa.kendall_stats.SeasonalMultiPartKendall.from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load the class from a serialised file</span>

<span class="sd">        :param path:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpk</span> <span class="o">=</span> <span class="n">SeasonalMultiPartKendall</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">min_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rm_na</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">serialise_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">mpk</span><span class="o">.</span><span class="n">serialise_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mpk</span><span class="o">.</span><span class="n">serialise</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mpk</span><span class="o">.</span><span class="n">_set_from_file</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nparts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expect_part</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_trend_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">rm_na</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">check_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">season_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mpk</span></div>


    <span class="k">def</span> <span class="nf">_calc_mann_kendall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        actually calculate the mann kendall from the sarray, this should be the only thing that needs</span>
<span class="sd">        to be updated for the seasonal kendall</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_start_points</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">temp_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">temp_key</span> <span class="ow">in</span> <span class="n">temp_data</span><span class="p">:</span>
                    <span class="n">datai</span> <span class="o">=</span> <span class="n">temp_data</span><span class="p">[</span><span class="n">temp_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">datai</span> <span class="o">=</span> <span class="n">_seasonal_mann_kendall_from_sarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                               <span class="n">season_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">season_data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
                                                               <span class="n">sarray</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s_array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span>
                                                                      <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
                                                               <span class="n">freq_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_limit</span><span class="p">)</span>  <span class="c1"># and passing the s array</span>
                    <span class="n">temp_data</span><span class="p">[</span><span class="n">temp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datai</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">datai</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
                                                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;split_point_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparts</span><span class="p">)]</span>
                                                             <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;var_s&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_calc_senslope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span><span class="p">,</span> <span class="n">lo_slope</span><span class="p">,</span> <span class="n">lo_intercept</span> <span class="o">=</span> <span class="n">_calc_seasonal_senslope</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_col</span><span class="p">],</span>
                                                                                 <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">season_col</span><span class="p">],</span>
                                                                                 <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">senslope</span><span class="p">,</span> <span class="n">senintercept</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Kо̄manawa Solutions Ltd..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>